{extend name="./oscshop/admin/view/public/base.html" /}
{block name="javascript"}
<script src="__PUBLIC__/ztree/jquery.ztree.all-3.5.min.js"></script>
<link  rel="stylesheet" type="text/css" href="__PUBLIC__/ztree/zTreeStyle.css" />
<link  rel="stylesheet" type="text/css" href="__PUBLIC__/ztree/tree.css" />
<script>
		var setting = {
			view: {
				addHoverDom: false,//用于当鼠标移动到节点上时，显示用户自定义控件，显示隐藏状态同 zTree 内部的编辑、删除按钮
				removeHoverDom: false,//用于当鼠标移出节点时，隐藏用户自定义控件，显示隐藏状态同 zTree 内部的编辑、删除按钮
				selectedMulti: false//设置是否允许同时选中多个节点。
			},
			edit: {
				enable: true,//是否可以编辑节点,
				editNameSelectAll: true,//是否全选input的txt内容
				showRemoveBtn: false,//删除时是否显示删除按钮
				showRenameBtn: false//设置是否显示编辑名称按钮
			},
			data: {
				simpleData: {
					enable: true//确定 zTree 初始化时的节点数据、异步加载时的节点数据、或 addNodes 方法中输入的 newNodes 数据是否采用简单数据模式 (Array)不需要用户再把数据库中取出的 List 强行转换为复杂的 JSON 嵌套格式
					// 如果设置为 true，请务必设置 setting.data.simpleData 内的其他参数: idKey / pIdKey / rootPId，并且让数据满足父子关系。
				}
			}
		};

	
	
	var zNodes ={$list};//控制传过来的数据


function save(type){
		var zTree = $.fn.zTree.getZTreeObj("category_tree"),//获取tree容器对象

		nodes = zTree.getSelectedNodes(),//获取当前被选中的节点数据集合
		treeNode = nodes[0];

		if(treeNode!=undefined){
			var isp= nodes[0].isParent;
		}else{
			var isp= true;
		}			
		var id=(treeNode==undefined?0:treeNode.id);

		if(type=='add'){
			url='{:url("MenuBackend/add")}';
		}else if(type=='edit'){
			url='{:url("MenuBackend/edit")}';
		}

		$.post(
			url,
			{					
				'id':id,
				'title':$("input[name='title']").val(),
				'url':$("input[name='url']").val(),
				'sort_order':$("input[name='sort_order']").val(),		
				'module':$("input[name='module']").val(),	
				'icon':$("input[name='icon']").val(),	
				'type':$("input[name='type']:checked").val(),			
				
				
			},
			function(d){	
				
			    if(type=='add'){						
						if(d.error){
							alert(d.error);
						
						}else if(d.status=='success'){											
							//有父节点
					    	if(treeNode){
					    		treeNode = zTree.addNodes(treeNode, {id:d.id, pId:id, isParent:isp, name:d.name});
					    	}else{
					    		treeNode = zTree.addNodes(treeNode, {id:d.id, pId:0, isParent:isp, name:d.name});
					    	}
					    	
					    	close_artDialog();
					    }	
					}else if(type=='edit'){
						
						if(d.success){
							nodes[0].name = d.name;
							zTree.updateNode(nodes[0]);
							
							close_artDialog();
						}
						if(d.error){
							alert(d.error);
						}
						
						
					}
			}
		);	
}

function add(e) {
	
	var dialog=$('#dialog').html();
	
	var title='新增菜单';
	
	art.dialog({
		title: title,
		content:dialog,
		lock: true,//?
		ok: function () {	 		
	 	  save('add');	    	
	      return false;
	    },
	    cancelVal: '关闭',
		cancel: true 
	});	
}
function edit() {
	
	var zTree = $.fn.zTree.getZTreeObj("category_tree"),
		nodes = zTree.getSelectedNodes(),
		treeNode = nodes[0];
		if (nodes.length == 0) {
			alert("请先选择一个节点");
			return;
		}else{
			var id=treeNode.id;
			$.post(
				'{:url("MenuBackend/get_info")}',
				{					
					'id':id,
					
				},
				function(d){			
					$("input[name='title']").val(d.title);
					$("input[name='url']").val(d.url);
					$("input[name='sort_order']").val(d.sort_order);
					$("input[name='module']").val(d.module);
					$("input[name='icon']").val(d.icon);
					
					
					if(d.type=='nav'){
						$("#nav").attr("checked","checked");
					}else if(d.type=='auth'){
						$("#auth").attr("checked","checked");
					}
				}
			);				
		}
			
	var dialog=$('#dialog').html();

	var title='修改菜单';
	
	art.dialog({
		title: title,
			content:dialog,
			lock: true,
			ok: function () {
				save('edit');
				return false;
			},
		    cancelVal: '关闭',
			cancel: true 
	});	
				
	
}
function remove(e) {
	
			if(!confirm('确认要删除吗！！')){
				return false;
			}
			
			var zTree = $.fn.zTree.getZTreeObj("category_tree"),
			nodes = zTree.getSelectedNodes(),
			treeNode = nodes[0];
			if (nodes.length == 0) {
				alert("请先选择一个节点");
				return;
			}
			$.post(
				'{:url("MenuBackend/del")}',
				{					
					'id':treeNode.id,					
				},
				function(d){			
					if(d.error){
						alert(d.error);
					}else{						
						zTree.removeNode(treeNode);
					}
					
					
				}
			);
}


$(document).ready(function(){
	$.fn.zTree.init($("#category_tree"), setting, zNodes);//初始化节点数据时，根据 treeNode.children 属性判断，有子节点则设置为 true，否则为 false
	// 初始化节点数据时，如果设定 treeNode.isParent = true，即使无子节点数据，也会设置为父节点
	$("#addParent").bind("click", {isParent:true}, add);//新添加的菜单目录指定为父节点
	$("#edit").bind("click", edit);
	$("#remove").bind("click", remove);
});
	
</script>
{/block}

{block name="content"}
<div class="page-header">
	<h1>	
		{$breadcrumb1}
		<small>
			<i class="ace-icon fa fa-angle-double-right"></i>
			{$breadcrumb2}
		</small>
	</h1>
</div>
<div class="page-header">
	<a id="addParent" class="btn btn-primary">新增</a>
	<a id="edit" class="btn btn-primary">编辑</a>
	<a id="remove" class="btn btn-primary">删除</a>
</div>

<div class="row">
	<div id="category_tree" class="ztree"></div>
</div>

	
	<div id="dialog" class="dialog" style="display:none">
    <div class="dialog_content">
    
        <dl>
        	<dt>菜单名称</dt>
        	<dd><input type="text" name="title" class="text" /></dd>
        	<dt>URL</dt>
    		<dd><input name="url" type="text" value="" size="50"  /></dd>    	
    		
    		<dt>模块</dt>
    		<dd><input name="module" type="text" value=""  /></dd>  
    		
    		<dt>图标</dt>
    		<dd><input name="icon" type="text" value=""  /></dd> 
    		
    		<dt>类型</dt>
    		<dd>
    			<label>
    				<input id="nav" name="type" type="radio" value="nav" checked="checked" /> 显示 
    			</label>
    			<label>
    				<input id="auth" name="type" type="radio" value="auth"  /> 不显示
    			</label>
    		</dd>   
    			
    		<dt>排序</dt>
    		<dd>
    			<input name="sort_order" type="text" value="" />
    		</dd>
    		
    		
        </dl>       
   
      
    </div>
  </div> 
	
{/block}

